name: deploy
on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

jobs:
  ci:
    name: "CI"
    runs-on: self-hosted
    env:
      OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
    steps:
      - name: Run classifier tests
        shell: bash
        run: |
          cd /home/ubuntu/PycharmProjects/modic_ai
          eval "$(conda shell.bash hook)"
          conda activate worker
          pip install --upgrade -r requirements.txt
          cd consumer
          python generation_consumer_test.py --cases "./generation_test"
      
  cd:
    name: "CD"
    runs-on: self-hosted
    needs: ci
    steps:
      - name: Deploy and restart all consumer workers
        run: |
          echo "ðŸš€ Starting deployment of generation_consumer workers"
          
          cd /home/ubuntu/PycharmProjects/modic_ai/
          eval "$(conda shell.bash hook)"
          conda activate worker
          
          git fetch origin main
          git reset --hard origin/main
          git pull
          
          pip install -r requirements.txt --upgrade
          
          cd consumer
          for i in 1 2 3 4; do
            echo "Restarting generation_consumer@$i ..."
            echo "${{ secrets.PASSWD }}" | sudo -S systemctl restart generation_consumer@$i
          done
          
          echo "All workers restarted successfully!"







